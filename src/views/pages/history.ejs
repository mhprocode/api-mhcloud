<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<header class="bg-white shadow">
  <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Histori Request API</h1>
  </div>
</header>

<main class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
     <% if (locals.error) { %>
        <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <%= error %>
        </div>
    <% } %>
    <% if (locals.success) { %>
         <div class="mb-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
            <%= success %>
        </div>
    <% } %>

    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Endpoint</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address & Aksi</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status Request</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          
          <% if (logs && logs.length > 0) { %>
            <% logs.forEach(log => { %>
              
              <% const userExists = log.apiKey && log.apiKey.user; %>

              <tr class=" <%= userExists && log.apiKey.user.isBanned ? 'bg-red-50 opacity-70' : 'hover:bg-gray-50' %> ">
                
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  <%= new Date(log.requestedAt).toLocaleString('id-ID', { hour12: false }) %>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <% if (userExists) { %>
                    <div class="font-medium text-gray-900"><%= log.apiKey.user.name || '[No Name]' %></div>
                    <div class="text-gray-500"><%= log.apiKey.user.email %></div>
                  <% } else { %>
                    <div class="text-gray-500 italic">[User Dihapus]</div>
                  <% } %>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-sm space-y-2">
                  <% if (userExists) { %>
                    <span class="font-bold px-2 py-1 rounded-full text-xs 
                        <%= log.apiKey.user.role === 'PREMIUM' ? 'bg-yellow-100 text-yellow-800' : 'bg-indigo-100 text-indigo-800' %>">
                        <%= log.apiKey.user.role %>
                    </span>
                    <span class="font-bold px-2 py-1 rounded-full text-xs 
                        <%= log.apiKey.user.isBanned ? 'bg-red-200 text-red-900' : 'bg-green-100 text-green-800' %>">
                        <%= log.apiKey.user.isBanned ? 'DIBLOKIR' : 'AKTIF' %>
                    </span>
                  <% } else { %>
                    <span class="text-gray-400">-</span>
                  <% } %>
                </td>
                
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">
                  <%= log.endpoint %>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">
                  <div><%= log.ipAddress || 'N/A' %></div>
                   <% if (log.ipAddress) { %>
                        <form action="/admin/ip-bans/quick-ban" method="POST" class="inline">
                            <input type="hidden" name="ipAddress" value="<%= log.ipAddress %>">
                            <button type="submit" class="text-red-600 hover:text-red-900 text-xs font-medium" title="Blokir IP ini">
                                [Ban IP Ini]
                            </button>
                        </form>
                    <% } %>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-sm">
                   <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                             <% if (log.statusCode === 200) { %> bg-green-100 text-green-800 <% } 
                             else if (log.statusCode === 429) { %> bg-orange-100 text-orange-800 <% }
                             else if (log.statusCode === 401 || log.statusCode === 403) { %> bg-yellow-100 text-yellow-800 <% }
                             else { %> bg-red-100 text-red-800 <% } %>">
                    <%= log.statusCode %>
                  </span>
                </td>
                
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                Belum ada histori request.
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
</main>

<%- include('../partials/footer') %>