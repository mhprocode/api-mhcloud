<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<header class="bg-white shadow">
  <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Edit User: <%= user.email %></h1>
  </div>
</header>

<main class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto bg-white p-8 shadow-lg rounded-lg">
        <form action="/admin/users/update/<%= user.id %>" method="POST" class="space-y-6">
            
            <% if (locals.error) { %>
                <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <%= error %>
                </div>
            <% } %>

            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email User</label>
                <input type="email" name="email" id="email" value="<%= user.email %>" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            
            <div>
                <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                <select id="role" name="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <% roles.forEach(role => { %>
                        <option value="<%= role %>" <%= user.role === role ? 'selected' : '' %>>
                            <%= role %>
                        </option>
                    <% }) %>
                </select>
            </div>
            
             <% if (user.apiKey) { %>
                <div>
                    <label for="monthlyLimit" class="block text-sm font-medium text-gray-700">Monthly Limit (Manual Override)</label>
                    <input type="number" name="monthlyLimit" id="monthlyLimit" value="<%= user.apiKey.monthlyLimit %>" placeholder="Kosongkan untuk limit default (sesuai Role)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <p class="text-xs text-gray-500 mt-1">Jika ini dikosongkan, limit akan mengikuti Role (FREE: 1000, PREMIUM: 50000).</p>
                </div>
                <div>
                    <label for="expiresAt" class="block text-sm font-medium text-gray-700">Expires At (Manual Override)</label>
                    <% 
                       let expiryValue = '';
                       if (user.apiKey.expiresAt) {
                           const d = new Date(user.apiKey.expiresAt);
                           // Sesuaikan dengan timezone lokal untuk input HTML
                           d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); 
                           expiryValue = d.toISOString().slice(0, 16);
                       }
                    %>
                    <input type="datetime-local" name="expiresAt" id="expiresAt" value="<%= expiryValue %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                     <p class="text-xs text-gray-500 mt-1">Kosongkan jika paket FREE atau untuk mengikuti default Role PREMIUM. (Role FREE akan otomatis mengabaikan ini).</p>
                </div>
            <% } %>

            <div class="flex justify-end space-x-4 pt-4 border-t">
                <a href="/admin/users" class="inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                    Batal
                </a>
                <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                    Update User
                </button>
            </div>
        </form>
    </div>
</main>

<%- include('../partials/footer') %>